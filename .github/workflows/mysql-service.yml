name: mysql-service
on: push

jobs:
  run-mysql:
    runs-on: ubuntu-latest
    # services:
    #   mysql:
    #     image: bitnami/mysql:8.0.20
    #     env:
    #       ALLOW_EMPTY_PASSWORD: yes
    #       MYSQL_DATABASE: test
    #       MYSQL_AUTHENTICATION_PLUGIN: mysql_native_password
    #     ports:
    #       - 3306:3306
    #     options: >-
    #       --health-cmd="mysqladmin ping"
    #       --health-interval=10s
    #       --health-timeout=5s
    #       --health-retries=3

    env:
      DB_PASSWORD: root

    steps:
      - uses: actions/checkout@v4
      - name: Verify tests database exists
        run: |
          sudo /etc/init.d/mysql start
          mysqladmin ping -uroot -p ${{ env.DB_PASSWORD }}
      - name: Create test database
        run: mysql -uroot -p ${{ env.DB_PASSWORD }} -e "CREATE DATABASE IF NOT EXISTS test;"
      - name: Create users table
        run: |
          mysql -uroot -p ${{ env.DB_PASSWORD }} -e "USE test; CREATE TABLE IF NOT EXISTS users (id INT NOT NULL AUTO_INCREMENT, name VARCHAR(255) NOT NULL, PRIMARY KEY (id));"
      - name: Insert test data
        run: |
          mysql -uroot -p ${{ env.DB_PASSWORD }} -e "USE test; INSERT INTO users (name) VALUES ('Alice');"
          mysql -uroot -p ${{ env.DB_PASSWORD }} -e "USE test; INSERT INTO users (name) VALUES ('Bob');"
      - name: Get all users
        run: |
          mysql -uroot -p ${{ env.DB_PASSWORD }} -e "USE test; SELECT * FROM users;"
